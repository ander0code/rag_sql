# Flujo RAG-SQL: Anรกlisis de Uso de IA

Este documento muestra el flujo real del proyecto y dรณnde se usa IA para identificar oportunidades de optimizaciรณn.

---

## Flujo Actual con Tiempos

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                            FLUJO RAG-SQL ACTUAL                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Usuario: "cuantos partidos ganรณ el equipo X"
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASO 1: INICIALIZACIรN                                              ~0.1s  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โข Cargar cache de esquemas (discovered_schemas.json)                        โ
โ  โข NO usa IA โ                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASO 2: CONEXIรN LLM                                                ~3.5s  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โข Conectar a Deepseek/OpenAI                                                โ
โ  โข Test de conexiรณn (envรญa "test")                                           โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ ๐ค USA IA: LLM base (Deepseek-chat / GPT-4o-mini)                     โ  โ
โ  โ ๐ Ubicaciรณn: infrastructure/llm/clients.py                            โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASO 3: SELECCIรN DE TABLAS                                         ~2.0s  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โข Input: Query + Lista de 26 tablas con columnas                            โ
โ  โข Output: ["partidos", "equipos"]                                           โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ ๐ค USA IA: LLM decide quรฉ tablas son relevantes                       โ  โ
โ  โ ๐ Ubicaciรณn: core/retrieval/schema_retriever.py                       โ  โ
โ  โ ๐ Prompt: "Selecciona tablas MรNIMAS para: {query}"                   โ  โ
โ  โ โก OPTIMIZABLE: Puede reemplazarse con modelo destilado o reglas       โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASO 4: GENERACIรN DE SQL                                           ~3.2s  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โข Input: Query + Tablas seleccionadas + Esquema                             โ
โ  โข Output: "SELECT COUNT(*) FROM partidos WHERE ..."                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ ๐ค USA IA: LLM genera consulta SQL                                    โ  โ
โ  โ ๐ Ubicaciรณn: core/generation/sql_generator.py                         โ  โ
โ  โ ๐ Prompt: "Genera SQL PostgreSQL para: {query}"                       โ  โ
โ  โ โก OPTIMIZABLE: Modelo SQLCoder destilado (7B) o fine-tuned            โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASO 5: EJECUCIรN SQL                                               ~1.5s  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โข Ejecutar query en PostgreSQL (Render)                                     โ
โ  โข NO usa IA โ (solo red + DB)                                               โ
โ  ๐ Ubicaciรณn: core/execution/query_executor.py                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASO 6: GENERACIรN DE RESPUESTA                                     ~1.9s  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โข Input: Query + Resultado SQL (filas/columnas)                             โ
โ  โข Output: "El equipo X ganรณ 15 partidos"                                    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ ๐ค USA IA: LLM convierte datos a lenguaje natural                     โ  โ
โ  โ ๐ Ubicaciรณn: core/generation/response_generator.py                    โ  โ
โ  โ โก OPTIMIZABLE: Puede eliminarse (respuesta directa como tabla)        โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
                    โโโโโโโโโโโโโโโ
                    โ  RESPUESTA  โ
                    โ   ~8.6s     โ
                    โโโโโโโโโโโโโโโ
```

---

## Resumen de Uso de IA

| Paso | ยฟUsa IA? | Tiempo | Archivo | Modelo Actual |
|------|----------|--------|---------|---------------|
| 1. Cache | โ | 0.1s | - | - |
| 2. Conexiรณn | โ๏ธ (test) | 3.5s | `clients.py` | Deepseek/GPT |
| 3. Selecciรณn tablas | โ | 2.0s | `schema_retriever.py` | Deepseek/GPT |
| 4. Generar SQL | โ | 3.2s | `sql_generator.py` | Deepseek/GPT |
| 5. Ejecutar SQL | โ | 1.5s | `query_executor.py` | - |
| 6. Generar respuesta | โ | 1.9s | `response_generator.py` | Deepseek/GPT |

**Total IA: 3 llamadas = ~7.1s (83% del tiempo)**

---

## Estrategias de Optimizaciรณn

### Opciรณn A: Eliminar Llamadas LLM Innecesarias

| Cambio | Ahorro | Cรณmo |
|--------|--------|------|
| Quitar test de conexiรณn | -3.5s | Conectar lazy |
| Quitar selecciรณn de tablas | -2.0s | Usar todas o palabras clave |
| Quitar generaciรณn respuesta | -1.9s | Mostrar tabla directa |
| **Total** | **-7.4s** | **~1.2s total** |

### Opciรณn B: Usar Modelo Destilado Local (SQLCoder)

```
Actual:            Deepseek API (China) โ 3.2s por llamada
Optimizado:        SQLCoder local (Ollama) โ 0.3s por llamada
```

| Modelo | Tamaรฑo | Especialidad | Velocidad |
|--------|--------|--------------|-----------|
| SQLCoder-7B | 4GB | SQL | 0.2-0.5s |
| DeepSeek-Coder-1.3B | 1GB | Cรณdigo | 0.1-0.3s |
| Phi-3-mini | 2GB | General | 0.2-0.4s |

### Opciรณn C: Fine-tuning para SQL especรญfico

Entrenar modelo pequeรฑo (1-3B) con ejemplos de tu dominio:

```python
# Ejemplos de entrenamiento para torneos de fรบtbol
training_data = [
    {"query": "partidos ganados", "sql": "SELECT * FROM partidos WHERE resultado = 'ganado'"},
    {"query": "goles del equipo", "sql": "SELECT SUM(goles) FROM partidos WHERE equipo_id = ?"},
    {"query": "tabla de posiciones", "sql": "SELECT * FROM posiciones ORDER BY puntos DESC"},
]
```

---

## Flujo Optimizado Propuesto

```
Usuario: "cuantos partidos ganรณ el equipo X"
                    โ
                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASO 1: Generar SQL                  ~0.3s โ
โ  SQLCoder local (sin API externa)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASO 2: Ejecutar SQL                 ~0.5s โ
โ  PostgreSQL                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PASO 3: Formatear Respuesta          ~0.1s โ
โ  Template simple (sin LLM)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
              RESPUESTA: ~0.9s
```

**De 8.6s a menos de 1s** con modelo local + flujo simplificado.

---

## Prรณximos Pasos para Implementar

1. [ ] Instalar Ollama + SQLCoder
2. [ ] Crear cliente local para SQLCoder
3. [ ] Eliminar llamada de selecciรณn de tablas
4. [ ] Simplificar generaciรณn de respuesta
5. [ ] Benchmark comparativo
